"use strict";angular.module("squareteam.resources",["ngCookies","ngResource"]),angular.module("squareteam.api",["pascalprecht.translate"]),angular.module("squareteam.app",["squareteam.api","squareteam.resources","ngSanitize","ui.router","pascalprecht.translate","angulartics","angulartics.google.analytics","ngDialog","restmod","angularMoment","truncate","angular-svg-round-progress"]),angular.module("squareteam.app").value("_",window._);var version="0.4.0";angular.module("squareteam.app").value("VERSION",version),angular.module("squareteam.api").config(["$httpProvider",function(a){a.interceptors.push("ApiHttpInterceptors")}]),angular.module("squareteam.app").run(["moment",function(a){a.locale("en",{calendar:{lastDay:"[yesterday at] LT",sameDay:"[today at] LT",nextDay:"[tomorrow at] LT",lastWeek:"[last] dddd [at] LT",nextWeek:"dddd [at] LT",sameElse:"L"}})}]).config(["$stateProvider","$urlRouterProvider","$translateProvider","$analyticsProvider","ngDialogProvider",function(a,b,c,d,e){e.setDefaults({className:"ngdialog-theme-squareteam",showClose:!0,closeByDocument:!0,closeByEscape:!0}),d.virtualPageviews(null===window.location.hostname.match(/dev\.squareteam/)),c.useStaticFilesLoader({prefix:"i18n/",suffix:".json"}),c.preferredLanguage("en");var f={checkAuthenticated:function(a,b,c){var d=b.defer();return a.isAuthenticated()?d.resolve():a.restore().then(angular.bind(this,function(){a.isAuthenticated()?d.resolve():(c.info("redirect to login"),d.reject({redirectToState:"public.login"}))})),d.promise},checkAnonymous:function(a,b){var c=b.defer();return a.isAuthenticated()?c.reject({redirectToState:"app.home"}):a.restore().then(angular.bind(this,function(){a.isAuthenticated()?c.reject({redirectToState:"app.home"}):c.resolve()})),c.promise},currentOrganization:function(a,b,c,d){var e=c.defer();return b.getOrganizations().then(function(a){var b=$.grep(a,function(a){return a.id===parseInt(d.organizationId,10)});1===b.length?e.resolve(b[0]):e.reject(new Error(["Organization #",d.organizationId," not found"].join("")))}),e.promise}};f.checkAuthenticated.$inject=["CurrentSession","$q","$log"],f.checkAnonymous.$inject=["CurrentSession","$q"],f.currentOrganization.$inject=["authenticated","CurrentSession","$q","$stateParams"],a.state("public",{"abstract":!0,resolve:{anonymous:f.checkAnonymous},templateUrl:"views/public/layout.html"}).state("public.login",{url:"/login",controller:"LoginCtrl",templateUrl:"views/public/login.html"}).state("public.oauth_check",{url:"/oauth/check",controller:"OAuthLoginCtrl",templateUrl:"views/public/oauth/login.html"}).state("public.oauth_email",{url:"/oauth/email",controller:"OAuthEmailConfirmCtrl",templateUrl:"views/public/oauth/email.html"}).state("public.register",{url:"/register",templateUrl:"views/public/register.html"}).state("public.forgotPassword",{"abstract":!0,template:"<ui-view></ui-view>"}).state("public.forgotPassword.request",{url:"/forgot_password/request",controller:"forgotPasswordCtrl",templateUrl:"views/public/forgotPassword/request.html"}).state("public.forgotPassword.request_sent",{url:"/forgot_password/request_sent",templateUrl:"views/public/forgotPassword/request_sent.html"}).state("public.forgotPassword.change",{url:"/forgot_password/change/:token",controller:"forgotPasswordCtrl",templateUrl:"views/public/forgotPassword/change.html"}).state("public.forgotPassword.changed",{url:"/forgot_password/change_success",templateUrl:"views/public/forgotPassword/change_success.html"}).state("public.organization.invite",{url:"/invite/organization/:id"}),a.state("app",{"abstract":!0,resolve:{authenticated:f.checkAuthenticated},templateUrl:"views/app/layout.html"}).state("app.home",{url:"/home",templateUrl:"views/app/home.html",controller:"HomeCtrl"}).state("app.account",{url:"/account",controller:"MyAccountCtrl",templateUrl:"views/app/account.html"}).state("app.knowledge",{url:"/knowledge",templateUrl:"views/app/knowledge/index.html"}).state("app.knowledge.create",{url:"/knowledge/add"}).state("app.knowledge.edit",{url:"/knowledge/edit/:item_id"}).state("app.knowledge.by_project",{url:"/knowledge/filter/:projectId/:missionId/:tags"}).state("app.user_projects",{url:"/users/:userId/projects",templateUrl:"views/app/project_list.html",controller:"ProjectsListCtrl"}).state("app.organization_projects",{url:"/organizations/:organizationId/projects",templateUrl:"views/app/project_list.html",controller:"ProjectsListCtrl"}).state("app.user_project_missions",{url:"/users/:userId/projects/:projectId/missions",templateUrl:"views/app/project_view.html",controller:"ProjectViewCtrl"}).state("app.organization_project_missions",{url:"/organizations/:organizationId/projects/:projectId/missions",templateUrl:"views/app/project_view.html",controller:"ProjectViewCtrl"}).state("app.missions.view",{url:"/:missionId"}).state("app.tasks",{url:"/tasks"}).state("app.tasks.view",{url:"/tasks/:taskId"}).state("app.organization_create",{url:"/organization/create",templateUrl:"views/register_organization.html"}).state("app.organizations",{url:"/organizations",templateUrl:"views/app/manage/organizations.html",controller:"Organizations"}).state("app.organization",{url:"/organization/:organizationId","abstract":!0,template:"<ui-view></ui-view>",resolve:{currentOrganization:f.currentOrganization}}).state("app.organization.manage",{url:"/manage",templateUrl:"views/app/manage/organization/index.html",controller:"ManageOrganizationCtrl"}),b.otherwise("/register")}]),angular.module("squareteam.app").factory("appConfig",function(){var a={host:"https://"+window.location.hostname,path:"/api/",storageNS:"st.session"};return a.url=a.host+a.path,a.oauth={cookieNS:"st.oauth"},a.oauth.github={endpoint:a.url+"auth/github",iconPath:"logo_github.png",name:"Github"},a.oauth.googleOauth2={endpoint:a.url+"auth/google_oauth2",iconPath:"logo_google.png",name:"Google"},{api:a}}),angular.module("squareteam.resources").factory("UserResource",["$http","restmod",function(a,b){var c=b.model("apis://users",{organizations:{hasMany:"OrganizationResource"},teams:{hasMany:"TeamResource"},projects:{hasMany:"ProjectResourceNested"}},"DirtyModel");return c.search=function(b){return a.get("apis://users/search",{params:{q:b}})},c.create=function(b){return a.post("api://users",b)},c}]),angular.module("squareteam.app").service("CurrentSession",["$rootScope","$http","$q","_","appConfig","ApiAuth","ApiCrypto","ApiErrors","ApiSessionStorageCookies","UserResource","AclRoles",function(a,b,c,d,e,f,g,h,i,j,k){this.$$user=null,this.$$auth=new f,this.$$userPermissions={},this.$$reloadUserPermissions=function(){var a=c.defer();return this.getUser().teams.$refresh().$then(angular.bind(this,function(b){function c(a){var b={};return d.each(a[0],function(c,e){return b[e]={},d.each(c,function(c,f){b[e][f]=!!Math.max.apply(null,d.map(a,function(a){return+a[e][f]}))})}),b}var e=d.groupBy(b,"organizationId");angular.forEach(e,function(a,b){angular.forEach(a,function(d){angular.forEach(d.users,function(d){d.id===this.$$user.id&&(this.$$userPermissions[b]=a.length>1&&this.$$userPermissions[b]?c([k.asBooleanMap(d.permissions),this.$$userPermissions[b]]):k.asBooleanMap(d.permissions))},this)},this)},this),a.resolve()}),a.reject),a.promise},this.userCanDo=function(a,b,c){return c?this.$$userPermissions[c]&&this.$$userPermissions[c][b]&&this.$$userPermissions[c][b][a]:!0},this.isAuthenticated=function(){return this.$$auth&&this.$$auth.$isValid()&&!!this.$$user},this.isOAuthAccount=function(){return"squareteam"!==this.$$user.provider.toLowerCase()},this.getOrganizations=function(){return this.$$user.organizations.$refresh().$promise},this.getAuth=function(){return this.$$auth},this.getUser=function(){return this.$$user},this.reloadUser=function(){b.get("apis://users/me").then(angular.bind(this,function(a){this.$$user=a.data}),angular.bind(this,function(){this.unregister()}))},this.unregister=function(){this.$$auth=new f,this.$$user=null,a.$broadcast("user:disconnected")},this.register=function(d){var f=this,i=c.defer();return b({method:"GET",url:e.api.url+"users/me",headers:angular.extend({"X-Requested-With":"XMLHttpRequest"},g.generateHeaders(d,e.api.url+"users/me","GET",{}))}).then(function(b){f.$$auth=d,f.$$user=j.$buildRaw(b.data),a.$broadcast("user:connected"),f.$$reloadUserPermissions().then(function(){i.resolve(b.data)},i.reject)},function(a){i.reject(a.error instanceof h.Http?"api.not_available":"auth.invalid")}),i.promise},this.save=function(){var a=c.defer(),b=!1;if(this.isAuthenticated()){try{b=i.store(this.getAuth())}catch(d){}b?a.resolve():a.reject("session.storage.unable_to_store")}else a.reject("session.invalid");return a.promise},this.restore=function(){var a,b=c.defer();try{a=i.retrieve()}catch(d){b.resolve(d)}return a?this.register(a).then(function(){b.resolve()},function(a){i.destroy(),b.resolve(a)}):b.resolve("session.storage.no_session"),b.promise}}]),angular.module("squareteam.api").factory("ApiHttpInterceptors",["$q","$injector","ApiErrors","appConfig",function(a,b,c,d){function e(a){a.error=angular.isDefined(a.data)&&angular.isDefined(a.data.errors)&&a.data.errors.length?new c.Api(a.data.errors):new c.Http(a.status,a.data)}var f=/^apis?:\/\//,g=/^apis:\/\//,h=new RegExp("^"+d.api.url);return{request:function(a){var c=b.get("ApiCrypto"),e=g.test(a.url);return f.test(a.url)&&(a.url=a.url.replace(f,d.api.url),e&&(a=c.transformRequest(a))),a},response:function(b){return h.test(b.config.url)?!b.data.errors&&b.status<=201?(b.data=b.data.data,b):(e(b),a.reject(b)):b},responseError:function(b){return e(b),a.reject(b)}}}]),angular.module("squareteam.api").service("ApiCrypto",["$injector","appConfig",function(a,b){this.$generateBlob=function(a){function b(a){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function c(a,d){var e=[];if(angular.isObject(a)&&"undefined"==typeof a.length){var f=Object.keys(a);f.sort();for(var g=0;g<f.length;g++)e.push(c(a[f[g]],d?[d,"{",f[g],"}"].join(""):f[g]));return e.join("&")}if(angular.isArray(a)){for(var h=0;h<a.length;h++)e.push(c(a[h],[d,"[]"].join("")));return e.join("&")}return[d,"=",b(a)].join("")}return c(a)},this.generateToken=function(a,b,c,d){var e=CryptoJS.PBKDF2(b,c,{keySize:8,iterations:1e3,hasher:CryptoJS.algo.SHA256}),f=CryptoJS.algo.HMAC.create(CryptoJS.algo.SHA256,d.concat(e));return f.update(a),f.finalize()},this.generateHeaders=function(a,c,d,e){var f,g,h,i="";return h=c.replace(b.api.host,""),"/"!==h[0]&&(h="/"+h),e&&(angular.isObject(e)||angular.isArray(e))&&(i=this.$generateBlob(e)),f={"St-Identifier":a.identifier,"St-Timestamp":Math.round(Date.now()/1e3)},g=CryptoJS.algo.HMAC.create(CryptoJS.algo.SHA256,a.token),g.update(d+":"),g.update(h+":"),g.update(f["St-Timestamp"]+":"),g.update(i),f["St-Hash"]=g.finalize().toString(),f["X-Requested-With"]="XMLHttpRequest",f},this.transformRequest=function(b){var c=a.get("CurrentSession"),d=c.getAuth();if(!c.isAuthenticated())throw new Error("Cannot load "+b.url+" without being authenticated !");return angular.extend(b.headers,this.generateHeaders(d,b.url,b.method,"GET"===b.method?b.params:b.data)),b}}]),angular.module("squareteam.api").service("ApiSessionStorageCookies",["$cookies","ApiAuth","appConfig",function(a,b,c){this.store=function(b){return b.$isValid()?void(a[c.api.storageNS]=CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse([b.identifier,b.token.toString()].join(":")))):!1},this.retrieve=function(){if(this.empty())return!1;var d=CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Base64.parse(a[c.api.storageNS])).split(":");return 2===d.length?new b(d[0],CryptoJS.enc.Hex.parse(d[1])):!1},this.destroy=function(){delete a[c.api.storageNS]},this.empty=function(){return angular.isUndefined(a[c.api.storageNS])}}]),angular.module("squareteam.api").factory("ApiAuth",function(){return function(a,b){this.token=b,this.identifier=a,this.$isValid=function(){return!!(this.token&&this.token.words&&this.token.sigBytes&&this.identifier)}}}),angular.module("squareteam.api").service("ApiSession",["$rootScope","$http","$q","appConfig","CurrentSession","ApiSessionStorageCookies","ApiAuth","ApiCrypto","ApiErrors",function(a,b,c,d,e,f,g,h,i){this.login=function(a,d){function f(){b.put("api://login",{identifier:a}).then(function(b){b&&b.data&&b.data.salt1&&b.data.salt1.length>0&&b.data.salt2&&b.data.salt2.length>0?(k.identifier=a,k.token=h.generateToken(a,d,CryptoJS.enc.Hex.parse(b.data.salt1),CryptoJS.enc.Hex.parse(b.data.salt2)),e.register(k).then(function(){e.save(),j.resolve()},function(a){j.reject("auth.invalid"===a?"auth.bad_password":"api.not_available")})):j.reject("api.response_malformed")},function(a){j.reject(a.error instanceof i.Http?"api.not_available":"auth.bad_login")})}var j=c.defer(),k=new g;return e.isAuthenticated()?this.logout().then(f,j.reject):f(),j.promise},this.logout=function(a){var d=c.defer();return a=angular.isDefined(a)?a:!0,e.isAuthenticated()?b.get("apis://logout").then(function(){a&&f.destroy(),e.unregister(),d.resolve()},function(){d.reject("api.not_available")}):d.reject("session.invalid"),d.promise}}]),angular.module("squareteam.app").controller("HomeCtrl",function(){}),angular.module("squareteam.app").directive("match",function(){return{require:"ngModel",restrict:"A",scope:{match:"="},link:function(a,b,c,d){a.$watch(function(){return d.$pristine&&angular.isUndefined(d.$modelValue)||a.match===d.$modelValue},function(a){d.$setValidity("match",a)})}}}),angular.module("squareteam.app").directive("stLoginForm",function(){return{templateUrl:"scripts/directives/templates/stloginform.html",restrict:"E",scope:{redirectPath:"@",githubLogin:"@",googleLogin:"@"},replace:!0,controller:["$scope","$element","$attrs","$state","$location","ApiSession","ApiOAuth",function(a,b,c,d,e,f,g){if(a.retries=0,g.isOAuthLoginRequest()){var h=g.oAuthLoginData();h.provider&&h.email&&"squareteam"===h.provider.toLowerCase()&&(a.user={email:h.email},a.youAlreadyHaveAccount=!0)}a.setDirty=function(){angular.forEach(["email","password"],function(b){var c=a.loginForm[b];c.$setViewValue(c.$viewValue)})},a.login=function(){a.loginForm.email.$setValidity("valid",!0),a.loginForm.password.$setValidity("valid",!0),a.serverBusy=!1,a.youAlreadyHaveAccount=!1,f.login(a.user.email,a.user.password).then(function(){d.go(a.redirectPath||"app.home")},function(b){a.retries++,"auth.bad_login"===b?a.loginForm.email.$setValidity("valid",!1):"auth.bad_password"===b?a.loginForm.password.$setValidity("valid",!1):a.serverBusy=!0})}}],link:function(a,b){angular.forEach(b.find("input"),function(a){a.addEventListener("invalid",function(a){a.preventDefault()},!0)})}}}),angular.module("squareteam.app").factory("ApiErrors",function(){function a(a){this.errors=a}function b(a,b){this.status=a,this.message=b}return angular.extend(a.prototype,{toString:function(){return"ApiError : "+this.errors.join(", ")},getErrors:function(){return this.errors}}),angular.extend(b.prototype,{toString:function(){return"HttpError("+this.status+"): "+this.message}}),{Api:a,Http:b}}),angular.module("squareteam.app").run(["$rootScope","$state",function(a,b){a.$on("$stateChangeError",function(a,c,d,e,f,g){angular.isObject(g)&&g.redirectToState&&g.redirectToState!==c.name&&b.go(g.redirectToState)})}]),angular.module("squareteam.app").directive("stUserCreate",function(){return{templateUrl:"scripts/directives/templates/stusercreate.html",restrict:"E",replace:!0,controller:["$scope","$element","$attrs","$location","UserResource","ApiErrors","CurrentSession","ApiSession","ApiCrypto","ApiAuth","stPolicies",function(a,b,c,d,e,f,g,h,i,j,k){a.setDirty=function(){angular.forEach(["email","password","confirmPassword","login","cgu"],function(b){var c=a.registerForm[b];c.$setViewValue(c.$viewValue)})},a.passwordFormat=function(){a.passwordBadPractice=!k.isPasswordValid(a.user.password)},a.register=function(){a.registerForm.email.$setValidity("unique",!0),a.serverBusy=!1,e.create({name:a.user.login,email:a.user.email,password:a.user.password}).then(function(b){var c=i.generateToken(a.user.email,a.user.password,CryptoJS.enc.Hex.parse(b.data.salt1),CryptoJS.enc.Hex.parse(b.data.salt2));g.register(new j(a.user.email,c)).then(function(){g.save(),$("body, html").scrollTop(0),d.path("/home")},function(){a.serverBusy=!0})},function(b){b.error instanceof f.Api?angular.forEach(b.error.getErrors(),function(b){"api.already_taken.Email"===b&&a.registerForm.email.$setValidity("unique",!1)},this):a.serverBusy=!0})}}],link:function(a,b){angular.forEach(b.find("input"),function(a){a.addEventListener("invalid",function(a){a.preventDefault()},!0)})}}}),angular.module("squareteam.resources").factory("OrganizationResource",["$resource","$q","$http","restmod",function(a,b,c,d){var e=d.model("apis://organizations",{teams:{hasMany:"TeamResource"},projects:{hasMany:"ProjectResourceNested"}},"AclModel");return e.createWithAdmins=function(a,b){return a.admins_ids=b,c.post("apis://organizations/with_admins",a)},e}]),angular.module("squareteam.app").controller("ApplicationCtrl",["$rootScope","$scope","$state","$translate","ApiSession","CurrentSession","VERSION",function(a,b,c,d,e,f,g){b.session=e,b.currentSession=f,b.version=g,b.$translate=d,b.logout=function(){e.logout().then(function(){c.go("public.login")},function(){c.go("app.home")})}}]),angular.module("squareteam.app").directive("stOrganizationCreate",function(){return{scope:{forUsers:"=",redirectPath:"@"},templateUrl:"scripts/directives/templates/storganizationcreate.html",restrict:"E",replace:!0,controller:["$scope","$element","$attrs","$location","$http","$state","OrganizationResource","CurrentSession","ApiErrors",function(a,b,c,d,e,f,g,h,i){function j(b){b.error instanceof i.Api?angular.forEach(b.error.getErrors(),function(b){"api.already_taken.Name"===b&&a.createOrganizationForm.name.$setValidity("unique",!1)}):a.serverBusy=!0}a.create=function(){a.serverBusy=!1,a.createOrganizationForm.name.$setValidity("unique",!0),g.createWithAdmins(a.organization,a.forUsers||[]).then(function(b){h.$$reloadUserPermissions().then(function(){a.redirectPath?d.path(a.redirectPath):f.go("app.organization.manage",{organizationId:b.data.id})},j)},j)}}]}}),angular.module("squareteam.app").controller("LoginCtrl",["$scope","$state","$injector","ApiOAuth",function(a,b,c,d){d.redirectIfLogin(),d.redirectIfEmailConfirmation()}]),angular.module("squareteam.app").directive("stCurrentUserBlock",["$timeout",function(a){return{restrict:"E",transclude:!0,replace:!0,templateUrl:"scripts/directives/templates/stcurrentuserblock.html",link:function(b,c){function d(a){g===a.target||$.contains(g,a.target)||g.is(":visible")&&(g.hide(),$(document).off("click",d))}var e=c.find(".avatar"),f=c.find(".user_dropdown"),g=$(f),h=e.offset();f.css({top:h.top+65+"px",left:h.left-(parseInt(f.css("width"),10)-parseInt(e.css("width"),10))/2-20+"px"}),e.on("click",function(){g.is(":visible")||(f.fadeIn(200),a(function(){$(document).on("click",d)},300))}),f.on("click",function(){f.hide()}),b.$watch("currentSession.isAuthenticated()",function(a){c[a?"show":"hide"]()}),b.$watch("currentSession.getUser()",function(a){a&&(b.userName=a.name)})}}}]),angular.module("squareteam.app").controller("forgotPasswordCtrl",["$scope","$stateParams","$http","$state","appConfig","ApiErrors","stPolicies",function(a,b,c,d,e,f,g){b.token?(a.passwordFormat=function(){a.passwordBadPractice=!g.isPasswordValid(a.user.password)},a.change=function(){c.post("api://forgot_password/change",{token:b.token,password:a.user.password}).then(function(){d.go("public.forgotPassword.changed")},function(b){404===b.status?a.tokenInvalid=!0:a.serverBusy=!0})}):a.request=function(){c.post("api://forgot_password",{email:a.user.email}).then(function(){d.go("public.forgotPassword.request_sent")},function(b){if(404===b.status)a.emailInvalid=!0;else if(b.error&&b.error instanceof f.Api&&"api.oauth_account"===b.error.getErrors()[0]){var c=b.error.getErrors()[1].provider;a.oAuthAccountFound=c,a.oAuthLoginLink=e.api.oauth[c].endpoint}else a.serverBusy=!0})}}]),angular.module("squareteam.app").directive("stOauthLink",function(){return{scope:{service:"@",mode:"@"},templateUrl:"scripts/directives/templates/stoauthlink.html",restrict:"E",replace:!0,controller:["$scope","$element","$attrs","$log","$translate","ApiOAuth",function(a,b,c,d,e,f){var g=f.providerConfig(a.service);return g?(a.serviceIconPath=g.iconPath,a.serviceEndpoint=g.endpoint,a.serviceName=g.name,void e("signin"===a.mode?"directives.stOAuthLink.signIn":"directives.stOAuthLink.signUp").then(function(b){a.actionName=b})):void d.error("no configuration for oauth service : "+a.service)}]}}),angular.module("squareteam.resources").factory("KnowledgeResource",["restmod",function(a){return a.model("apis://knowledges")}]),angular.module("squareteam.resources").factory("MissionResource",["restmod",function(a){return a.model("apis://missions","AclModel")}]),angular.module("squareteam.resources").factory("ProjectMissionResource",["restmod",function(a){return a.model("apis://missions","AclModel")}]),angular.module("squareteam.resources").factory("ProjectResource",["restmod","ProjectResourceConfig","moment",function(a,b,c){return a.model("apis://projects",{name:"projects",missions:{hasMany:"ProjectMissionResource"},progressAsNumber:{mask:!0},remainingDays:{mask:!0},remainingMonths:{mask:!0},"~afterFeed":function(){this.progressAsNumber=parseInt(this.progress,10),this.remainingDays=c().diff(c(this.deadline),"days"),this.remainingMonths=c().diff(c(this.deadline),"months")}},"AclModel",b)}]),angular.module("squareteam.resources").factory("ProjectResourceNested",["restmod","ProjectResourceConfig",function(a,b){return a.model({url:null,name:"projects"},"AclModel","ModelHelpers",b)}]),angular.module("squareteam.resources").factory("ProjectResourceConfig",["restmod",function(a){return a.mixin(function(){this.attrMask("status","C"),this.attrMask("metadata","CU"),this.attrMask("progress","CU"),this.attrMask("creator","CU"),this.attrMask("users","CU"),this.attrMask("createdAt","CU"),this.attrMask("id","CU"),this.attrEncoder("deadline",function(a){return null===a?"":a}),this.attrDecoder("progress",function(a){return a+"%"})})}]),angular.module("squareteam.resources").factory("TaskResource",["restmod",function(a){return a.model("apis://tasks","AclModel")}]),angular.module("squareteam.app").directive("stTopBar",function(){return{templateUrl:"scripts/directives/templates/sttopbar.html",restrict:"E",replace:!0,controller:function(){setTimeout(function(){$("nav .item").each(function(a,b){!function(a){setTimeout(function(){$(b).addClass("visible")},100*a)}(a)})},500)}}}),angular.module("squareteam.api").provider("ApiCache",function(){var a=this.$inflections={};this.$capacity=30,this.$get=["$cacheFactory","appConfig",function(b,c){function d(b){return a[b]?a[b]:"s"===b[b.length-1]?b.substr(0,b.length-1):b}var e,f=new RegExp("^"+c.api.url+"([a-zA-Z0-9]+)(?:/([a-zA-Z0-9]+))"),g=new RegExp("^"+c.api.url+"([a-zA-Z0-9]+)$");return e=b("apiCache",{capacity:this.$capacity}),{info:e.info,put:function(a,b){var c=a.match(g);if(c&&2===c.length){var f,h=d(c[1]),i=[];angular.forEach(b,function(a){f=[h,a.id].join(":"),i.push(f),e.put(f,a)}),e.put([a,"keys"].join(":"),i)}return e.put(a,b),b},get:function(a){var b=a.match(f);if(b&&3===b.length){var c=d(b[1]),g=b[2],h=e.get([c,g].join(":"));return h?h:e.get(a)}return e.get(a)},remove:function(a){e.remove(a);var b=this.get([a,"keys"].join(":"));b&&(angular.forEach(b,function(a){e.remove(a)}),e.remove([a,"keys"].join(":")))},removeAll:e.removeAll,destroy:e.destroy}}]}),angular.module("squareteam.resources").factory("TeamResource",["$resource","$http","$q","restmod",function(a,b,c,d){var e=d.model("apis://teams",{users:{hasMany:d.model(null)},color:{init:"#2cc1ff"}},"AclModel");return e.colors=["#2cc1ff","#ffeca0","#a4f8e2","#ffb9bc","#f0c0eb","#b7c9d1"],e}]),angular.module("squareteam.app").controller("ManageOrganizationCtrl",["$scope","$state","$q","$http","OrganizationResource","TeamResource","currentOrganization","ngDialog","CurrentSession",function(a,b,c,d,e,f,g,h,i){a.editingUsers=[],a.team=null,a.organization=e.$find(g.id).$then(function(){a.organization.teams.$fetch().$then(function(b){a.teams=b}),a.manageTeam=function(b){a.team=b,a.editingUsers=[]},a.openPopin=function(b){var d,e=a.$new();e.mode=b,e.Team=f,e.team="create"===b?a.organization.teams.$buildRaw({}):a.team,e.save=function(){e.team.$save().$then(function(){var a=[];angular.forEach(e.teamUsersDiff.added,function(b){a.push(e.team.users.$create({id:b.id,user_id:b.id,permissions:0,name:b.name}).$promise)}),angular.forEach(e.teamUsersDiff.deleted,function(b){a.push(b.$destroy().$promise)}),c.all(a).then(function(){i.$$reloadUserPermissions().then(function(){d.close()},d.close)},d.close)})},d=h.open({template:"views/app/manage/organization/popins/team.html",scope:e})},a.updateUser=function(b){d.put("apis://teams/"+a.team.id+"/users/"+b.id,{permissions:b.permissions}).then(function(){a.stopEditUser(b)})},a.removeUser=function(b){d.delete("apis://teams/"+a.team.id+"/users/"+b.id).then(function(){a.team.users.$remove(b)})},a.isEditing=function(b){return a.editingUsers.indexOf(b.id)>-1},a.stopEditUser=function(b){var c=a.editingUsers.indexOf(b.id);c>-1&&a.editingUsers.splice(c,1)}})}]),angular.module("squareteam.app").controller("Organizations",["$scope","$http","CurrentSession",function(a,b,c){c.getOrganizations().then(function(b){a.organizations=b}),a.leaveOrganization=function(d){b.delete("apis://organizations/"+d+"/users/"+c.getUser().id).then(function(){var b=-1;angular.forEach(a.organizations,function(a,c){a.id===d&&(b=c)}),b>=0&&a.organizations.splice(b,1)},function(){window.alert("Error while leaving organization, please try later.")})}}]),angular.module("squareteam.app").directive("stProjectCard",function(){return{scope:{project:"="},templateUrl:"scripts/directives/templates/stprojectcard.html",restrict:"E",replace:!0,controller:["$scope","$element","$attrs","$state","stTooltip",function(a,b,c,d,e){var f=a.$new(),g=null;f.status=function(b){a.project.status=b,a.project.$save().$then(function(){g&&(g.hide(),g=null)})},a.openChangeStatusTooltip=function(){g?(g.hide(),g=null):e.open("views/app/projects/tooltips/update_project_status_tooltip.html","edit_project_status",f).then(function(a){g=a,g.showOnNode($(b).find("button.editable"),25,0,!1)})},a.openProject=function(){var b=a.project.$closestParentByName(["users","organizations"]);"users"===b.constructor.$name()?d.go("app.user_project_missions",{userId:b.id,projectId:a.project.id}):d.go("app.organization_project_missions",{organizationId:b.id,projectId:a.project.id})}}]}}),angular.module("squareteam.app").controller("MyAccountCtrl",["$scope","$http","$location","ApiSession","CurrentSession","UserResource","PasswordConfirmPopin","appConfig","ApiErrors","ApiSessionStorageCookies","stUtils","stPolicies",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){d.login(a.user.email,b).catch(function(){alert("Refresh session failed !"),a.user.$restore()})}function n(){var b=h.api.oauth[a.user.provider]&&h.api.oauth[a.user.provider].endpoint;angular.isString(b)?(alert("profile updated, redirection..."),k.redirect(b,300)):(alert("oauth redirection failed, logout.."),e.unregister(),j.destroy(),c.path("/login"))}a.isOAuthAccount=e.isOAuthAccount(),a.user=e.getUser(),a.passwordFormat=function(){a.passwordBadPractice=!l.isPasswordValid(a.user.password)},a.updateUser=function(){var c=a.user.$dirty("password")||a.user.$dirty("email");a.user.$save().$then(function(){c?a.isOAuthAccount?n():g.prompt().then(function(c){a.user.$dirty("password")?b.put("apis://users/me/change_password",{password:a.user.password}).then(function(){e.unregister(),m(a.user.password)},function(){alert("Update canceled !"),a.user.$restore()}):m(c)},function(){alert("Update canceled !"),a.user.$restore()}):e.reloadUser()},function(b){b.error instanceof i.Api?angular.forEach(b.error.getErrors(),function(b){"api.already_taken.Email"===b&&a.userForm.email.$setValidity("unique",!1)},this):a.user.$restore()})}}]),angular.module("squareteam.app").service("PasswordConfirmPopin",["$rootScope","$q","ngDialog",function(a,b,c){this.prompt=function(){var d,e=b.defer(),f=a.$new();return f.confirm=function(){e.resolve(f.password),d.close()},d=c.open({template:"views/app/password_confirm_popin.html",scope:f}),d.closePromise.then(e.reject),e.promise}}]),angular.module("squareteam.app").service("stTooltip",["$rootScope","$http","$q","$compile","$templateCache","$timeout",function(a,b,c,d,e,f){function g(a){function b(c){a===c.target||$.contains(a,c.target)||a.is(":visible")&&(a.hide(),$(document).off("click",b))}function c(){$(document).on("click",b)}function d(b,c){a.css("left",c+"px").css("top",b+"px")}return{$el:a,hide:function(){a.fadeOut(200)},setPosition:d,showOnNode:function(b,e,g,h){var i=$(b).offset();h||"undefined"==typeof h?d(i.top+(e||0),i.left-(parseInt(a.css("width"),10)-parseInt($(b).css("width"),10))/2+(g||0)):d(i.top+(e||0),i.left+(g||0)),a.css("display","none"),a.fadeIn(200),f(function(){c()},300)},show:function(){a.fadeIn(200)},destroy:function(){a.remove()}}}function h(f,h,j){var k=c.defer();return angular.isObject(h)?(j=angular.isObject(h)?h.$new():a.$new(),h=null):j=angular.isObject(j)?j.$new():a.$new(),c.when(e.get(f)||b.get(f,{cache:!0})).then(function(a){var b,c,l=angular.isString(a)?a:a.data;e.put(f,l),h?(c=i[h],b=i[h]=d(l)(j),c?c.replaceWith(b):b.appendTo(document.body)):(b=d(l)(j),b.appendTo(document.body)),k.resolve(g(b))},k.reject),k.promise}var i={};return{open:h}}]),angular.module("squareteam.app").service("stUtils",["$window","$timeout",function(a,b){return{redirect:function(c,d){d=angular.isNumber(d)?d:0,b(function(){a.location=c},d)}}}]),angular.module("squareteam.app").controller("ProjectsListCtrl",["$scope","$rootScope","$location","$stateParams","ngDialog","ProjectResource","UserResource","CurrentSession","moment","_",function(a,b,c,d,e,f,g,h,i,j){a.organizations=[],a.sortBy="",a.teamFilter="",a.statusFilter="",a.currentUser=h.getUser(),a.statusFilterChoices=[{label:"directives.stProjectCard.status.inprogress",color:"#57c0df",value:"inprogress"},{label:"directives.stProjectCard.status.due",color:"#ff6e83",value:"due"},{label:"directives.stProjectCard.status.validation",color:"#cf83c0",value:"validation"},{label:"directives.stProjectCard.status.done",color:"#73c26D",value:"done"},{label:"directives.stProjectCard.status.paused",color:"#9cb6be",value:"paused"}],a.teamFilterChoices=[{label:"Team Panda",color:"#57c0df",value:"panda"},{label:"Team Tiger",color:"#73c26D",value:"tiger"},{label:"Team Snow",color:"#ff6e83",value:"snow"}],a.sortChoices=[{label:"app.projects.sort.deadline",value:"deadline",dir:"asc"},{label:"app.projects.sort.deadline",value:"-deadline",dir:"desc"},{label:"app.projects.sort.progress",value:"progress",dir:"asc"},{label:"app.projects.sort.progress",value:"-progress",dir:"desc"},{label:"app.projects.sort.date",value:"created_at",dir:"asc"},{label:"app.projects.sort.date",value:"-created_at",dir:"desc"}],a.loadProjects=function(){function b(b){a.projects=b}a.currentScope||!d.organizationId&&!d.userId||(d.userId&&a.currentUser.id===d.userId?a.currentScope=a.currentUser:d.organizationId&&(a.currentScope=j.find(a.organizations,{id:+d.organizationId}))),a.currentScope||(a.currentScope=a.currentUser),a.currentScope.projects.$refresh().$then(b)},h.getOrganizations().then(function(b){a.organizations=b,a.loadProjects()}),a.$on("project:delete",function(a,b){b.$destroy()}),a.currentUserCanCreateProject=function(){return a.currentScope?a.currentScopeIsUser()?!0:h.userCanDo("add","projects",a.currentScope.id):!1},a.currentScopeIsUser=function(){return a.currentScope&&"users"===a.currentScope.constructor.$name()},a.filteredOrganizations=function(){var b=[];return!a.currentScope||a.currentScope&&"users"===a.currentScope.constructor.$name()?b=a.organizations:angular.forEach(a.organizations,function(c){c.id!==a.currentScope.id&&b.push(c)}),b},a.isFiltered=function(){return a.teamFilter||a.statusFilter
},a.clearFilters=function(){a.teamFilter="",a.statusFilter=""},a.createProjectPopin=function(){var c,d=b.$new();d.createProject=function(){d.project.deadline&&(d.project.deadline=i(d.project.deadline).toISOString()),a.projects.$create(d.project).$then(function(){a.loadProjects(),c.close()})},c=e.open({template:"views/app/projects/popins/create_project_popin.html",scope:d})}}]),angular.module("squareteam.app").directive("stDropdown",["$parse","$timeout",function(a,b){return{restrict:"AC",link:function(c,d,e){function f(){i.fadeOut(200),d.removeClass("dropdown-open")}function g(a){i===a.target||$.contains(i,a.target)||i.is(":visible")&&(i.hide(),f(),$(document).off("click",g))}function h(){$(document).on("click",g)}var i=$(d).find(".dropdown_menu"),j=a(e.position||"absolute")(c),k=a(e.topPad||"")(c),l=a(e.leftPad||"")(c),m=isNaN(parseInt(k,0))?0:parseInt(k,10),n=isNaN(parseInt(l,0))?0:parseInt(l,10);d.on("click",function(a){if(i.is(":visible"))f();else{if("absolute"===j){var c=d.offset();i.css({top:c.top+m+"px",left:c.left-(parseInt(i.css("width"),10)-parseInt($(a.currentTarget).css("width"),10))/2-n+"px",display:"none"})}else i.css({top:0+m+"px",left:0+n+"px",display:"none"});i.fadeIn(200),d.addClass("dropdown-open"),b(function(){h()},300)}}),i.on("click",function(){f()})}}}]),angular.module("squareteam.app").directive("stSortDropdown",function(){return{scope:{stSortDropdown:"=",placeholder:"@",dropdownClasses:"@"},restrict:"AC",priority:10,transclude:!0,replace:!0,templateUrl:"scripts/directives/templates/stsortdropdown.html",require:"ngModel",link:function(a,b,c,d){function e(c){b.removeClass("icon-sort-asc"),b.removeClass("icon-sort-desc"),c?(b.addClass("active"),b.addClass("icon-sort-"+c.dir),a.selected=c):(b.removeClass("active"),a.selected=null)}a.selected=null,a.$watch("selectedIndex",function(b){angular.isNumber(b)&&a.stSortDropdown[b]&&(e(a.stSortDropdown[b]),d.$setViewValue(a.selected.value))}),d.$render=function(){for(var b=d.$viewValue||"",c=-1,f=a.stSortDropdown.length-1;f>=0;f--)a.stSortDropdown[f].value===b&&(c=f);e(c>-1?a.stSortDropdown[c]:null)}}}}),angular.module("squareteam.app").directive("stFilterDropdown",function(){return{scope:{stFilterDropdown:"=",placeholder:"@",dropdownClasses:"@"},restrict:"AC",priority:10,transclude:!0,replace:!0,templateUrl:"scripts/directives/templates/stfilterdropdown.html",require:"ngModel",link:function(a,b,c,d){function e(c){c?(b.addClass("active"),b.css("backgroundColor",c.color),a.selected=c):(b.removeClass("active"),b.css("backgroundColor",""),a.selected=null)}var f=$(b).find(".dropdown_menu").first();a.selected=null,f.delegate("li","mouseover",function(a){$(a.currentTarget).css("backgroundColor",$(a.currentTarget).data("color"))}),f.delegate("li","mouseout",function(a){$(a.currentTarget).css("backgroundColor","")}),a.selectById=function(b){angular.isNumber(b)&&a.stFilterDropdown[b]&&(e(a.stFilterDropdown[b]),d.$setViewValue(a.selected.value))},d.$render=function(){for(var b=d.$viewValue||"",c=-1,f=a.stFilterDropdown.length-1;f>=0;f--)a.stFilterDropdown[f].value===b&&(c=f);e(c>-1?a.stFilterDropdown[c]:null)}}}}),angular.module("squareteam.app").directive("stDateInput",function(){return{scope:{mask:"@"},templateUrl:"scripts/directives/templates/stdateinput.html",replace:!0,restrict:"E",require:"ngModel",link:function(a,b,c,d){function e(a){return a.toString().length<2?"0"+a:a.toString()}d.$render=function(){if(d.$viewValue){var b=d.$viewValue;d.$viewValue instanceof Date||(b=new Date(d.$viewValue)),"Invalid Date"!==b.toString()&&(a.day=e(b.getDate()),a.month=e(b.getMonth()+1),a.year=b.getFullYear())}},a.$watch("day + month + year",function(){a.day&&a.month&&a.year&&d.$setViewValue(new Date(a.year,a.month-1,a.day))}),$(b).find(".day").on("focus",function(){$(b).find(".day").on("keyup",function(){2===$(b).find(".day").val().length&&$(b).find(".month").focus()})}),$(b).find(".month").on("focus",function(){$(b).find(".month").on("keyup",function(){2===$(b).find(".month").val().length&&$(b).find(".year").focus()})})}}}),angular.module("squareteam.resources").factory("AclModel",["restmod","CurrentSession",function(a,b){return a.mixin(function(){this.define("$can",function(a){var c=!1,d=this.$scope;if("organizations"===this.constructor.$name())c=this.id;else do d.constructor&&d.constructor.$name&&"organizations"===d.constructor.$name()&&(c=d.id);while((d=d.$scope)&&!c);return b.userCanDo(a,this.constructor.$name(),c)})})}]),angular.module("squareteam.resources").factory("ModelHelpers",["restmod",function(a){return a.mixin(function(){this.define("$closestParentByName",function(a){var b=null,c=this;angular.isArray(a)||(a=[a]);do c.constructor&&c.constructor.$name&&a.indexOf(c.constructor.$name())>-1&&(b=c);while((c=c.$scope)&&!b);return b})})}]),angular.module("squareteam.resources").factory("AclRoles",function(){var a={MANAGE_TEAM:1,ADD_PROJECT:2,MANAGE_PROJECTS:4,ADD_TASK:8,MANAGE_TASKS:16,ADD_MISSION:32,MANAGE_ORGANIZATION:64,MANAGE_MISSION:128};return{ROLES:a,asBooleanMap:function(b){return{organizations:{manage:this.has(b,a.MANAGE_ORGANIZATION)},teams:{manage:this.has(b,a.MANAGE_TEAM)},projects:{manage:this.has(b,a.MANAGE_PROJECTS),add:this.has(b,a.ADD_PROJECT)},missions:{manage:this.has(b,a.MANAGE_MISSION),add:this.has(b,a.ADD_MISSION)},tasks:{manage:this.has(b,a.MANAGE_TASKS),add:this.has(b,a.ADD_TASK)}}},add:function(a,b){return a|b},has:function(a,b){return(a&b)===b&&0!==a},remove:function(a,b){return a&~b},all:function(){var b=0;return angular.forEach(a,function(a){b|=a}),b}}}),angular.module("squareteam.app").directive("stMissionItem",function(){return{scope:{mission:"="},templateUrl:"scripts/directives/templates/stmissionitem.html",restrict:"E",replace:!0}}),angular.module("squareteam.app").controller("ProjectViewCtrl",["$scope","$stateParams","$rootScope","$state","ProjectResource","CurrentSession","moment","ngDialog","_",function(a,b,c,d,e,f,g,h,i){a.draftsOnly={draft:1},a.sortBy="",a.sortChoices=[{label:"app.projects.sort.deadline",value:"deadline",dir:"asc"},{label:"app.projects.sort.deadline",value:"-deadline",dir:"desc"},{label:"app.projects.sort.progress",value:"progress",dir:"asc"},{label:"app.projects.sort.progress",value:"-progress",dir:"desc"},{label:"app.projects.sort.date",value:"created_at",dir:"asc"},{label:"app.projects.sort.date",value:"-created_at",dir:"desc"}],a.statusFilter="",a.statusFilterChoices=[{label:"directives.stProjectCard.status.inprogress",color:"#57c0df",value:"inprogress"},{label:"directives.stProjectCard.status.due",color:"#ff6e83",value:"due"},{label:"directives.stProjectCard.status.validation",color:"#cf83c0",value:"validation"},{label:"directives.stProjectCard.status.done",color:"#73c26D",value:"done"},{label:"directives.stProjectCard.status.paused",color:"#9cb6be",value:"paused"}],a.assigneeFilter="",a.isFiltered=function(){return a.assigneeFilter||a.statusFilter},a.clearFilters=function(){a.teamFilter="",a.assigneeFilter=""},e.$search().$then(function(b){a.projects=b,a.loadMissions()}),a.loadMissions=function(){function c(b){a.missions=b}!a.project&&b.projectId&&(a.project=i.find(a.projects,{id:+b.projectId})),a.project||(a.project=a.projects[0]),a.project.missions.$refresh().$then(c)},a.changeProject=function(a){"users"===a.ownerType?d.go("app.user_project_missions",{userId:a.owner.id,projectId:a.id}):d.go("app.organization_project_missions",{organizationId:a.owner.id,projectId:a.id})},a.filteredProjects=function(){return a.projects&&a.project?$.grep(a.projects,function(b){return b.id!==a.project.id}):[]},a.currentUserCanCreateMission=function(){return f.userCanDo("add","missions")},a.createMissionPopin=function(){var b,d=c.$new();d.createMission=function(){d.mission.deadline&&(d.mission.deadline=g(d.mission.deadline).toISOString()),a.project.missions.$create(d.mission).$then(function(){b.close()})},b=h.open({template:"views/app/missions/popins/create_mission_popin.html",scope:d})}}]),angular.module("squareteam.app").directive("stProjectEditIcon",function(){return{template:'<i class="icon icon-settings"></i>',restrict:"E",replace:!0,scope:{project:"="},controller:["$scope","$element","$attrs","moment","ngDialog","stTooltip",function(a,b,c,d,e,f){var g=a.$new(),h={};g.edit=function(){var b,c=a.$new();c.project={title:a.project.title,description:a.project.description,deadline:a.project.deadline},c.updateProject=function(){c.project.deadline instanceof Date&&(a.project.deadline=d(c.project.deadline).toISOString()),a.project.title=c.project.title,a.project.description=c.project.description,a.project.$save().$then(b.close)},h.updateProject&&h.updateProject.hide(),b=e.open({template:"views/app/projects/popins/update_project_popin.html",scope:c})},g.delete=function(){h.updateProject&&h.updateProject.hide(),a.project.$destroy()},b.on("click",function(){a.openUpdateProjectTooltip()}),a.openUpdateProjectTooltip=function(){h.updateProject?(h.updateProject.hide(),h.updateProject=null):f.open("views/app/projects/tooltips/edit_project_tooltip.html","edit_project",g).then(function(a){h.updateProject=a,h.updateProject.showOnNode(b,30)})}}]}}),angular.module("squareteam.app").filter("nl2br",["$sce",function(a){return function(b,c){return angular.isString(b)?(c=c||!0,b=(b+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(c?"<br />":"<br>")+"$2"),a.trustAsHtml(b)):""}}]),angular.module("squareteam.app").filter("u2camel",function(){return function(a){return angular.isString(a)?(a=a.replace(/(\_[a-z])/g,function(a){return a.toUpperCase().replace("_","")}),a=a.replace(/(\-[a-z])/g,function(a){return a.toUpperCase().replace("-","")})):""}}),angular.module("squareteam.app").directive("stUserAclEdit",function(){return{scope:{user:"="},templateUrl:"scripts/directives/templates/stuseracledit.html",restrict:"E",replace:!0,controller:["$scope","$element","$attrs","$state","$http","TeamResource","AclRoles",function(a,b,c,d,e,f,g){a.$watch("roleToAdd",function(b){angular.isNumber(b)&&(a.user.permissions=b)}),a.rolesHelpers=g,a.ROLES=g.ROLES,a.$watch("user",function(b){b&&angular.isNumber(b.permissions)&&(a.roleToAdd=b.permissions)})}]}}),angular.module("squareteam.app").directive("stCheckbox",function(){return{scope:{type:"@",label:"=",onChange:"&"},templateUrl:"scripts/directives/templates/stcheckbox.html",restrict:"E",replace:!0,require:"ngModel",link:function(a,b,c,d){d.$render=function(){(d.$viewValue===!0||d.$viewValue===!1)&&(a.value=d.$viewValue)},a.updateValue=function(b){(b===!0||b===!1)&&(a.value=b,d.$setViewValue(b))}}}}),angular.module("squareteam.app").directive("stColorPicker",function(){return{scope:{colors:"="},templateUrl:"scripts/directives/templates/stcolorpicker.html",restrict:"E",replace:!0,require:"ngModel",link:function(a,b,c,d){a.$watch("selectedColor",function(a){angular.isString(a)&&d.$setViewValue(a)}),d.$render=function(){var b=d.$viewValue||null;angular.isString(b)&&(a.selectedColor=b)}}}}),angular.module("squareteam.app").directive("stUserChooser",function(){return{templateUrl:"scripts/directives/templates/stuserchooser.html",restrict:"E",replace:!0,scope:{referential:"=",differential:"="},controller:["$scope","$element","$attrs","UserResource","_",function(a,b,c,d,e){a.selectedUsers=angular.copy(a.referential),a.$watch("search",function(b){$.trim(b).length?d.search(b).then(function(b){a.resultUsers=b.data,a.refreshList()}):(a.users=[],a.users=a.users.concat(a.selectedUsers))}),a.refreshList=function(){a.users=[],a.users=a.users.concat(a.resultUsers||[]),a.users=a.users.concat(a.selectedUsers||[]),a.users=e.uniq(a.users,"id")},a.toggleSelection=function(b){var c=a.selectUserIndex(b);c>-1?a.selectedUsers.splice(c,1):a.selectedUsers.push(b)},a.isSelected=function(b){return a.selectUserIndex(b)>-1},a.selectUserIndex=function(b){return e.findIndex(a.selectedUsers,{id:b.id})},a.$watchCollection("selectedUsers",function(){a.refreshList(),a.differential={deleted:[],added:[]},angular.forEach(a.selectedUsers,function(b){e.find(a.referential,{id:b.id})||a.differential.added.push(b)}),angular.forEach(a.referential,function(b){e.find(a.selectedUsers,{id:b.id})||a.differential.deleted.push(b)})})}],link:function(a,b){$(b).find(".search").on("keydown",function(b){return 27===b.keyCode?(b.stopImmediatePropagation(),b.preventDefault(),a.search="",a.$apply(),!1):void 0})}}}),angular.module("squareteam.api").factory("ApiOAuth",["$location","$cookies","$q","ApiSession","appConfig","u2camelFilter",function(a,b,c,d,e,f){return{redirectIfLogin:function(){this.isOAuthLoginRequest()&&a.path("/oauth/check")},redirectIfEmailConfirmation:function(){this.isOAuthEmailMissingRequest()&&a.path("/oauth/email")},isOAuthLoginRequest:function(){var c=a.search()&&f(a.search().provider);return c&&a.search()&&a.search().email&&b[e.api.oauth.cookieNS]&&e.api.oauth[c]},oAuthLoginData:function(){return{provider:a.search().provider,email:a.search().email,tmpKey:b[e.api.oauth.cookieNS]}},login:function(){var a,f=c.defer();return this.isOAuthLoginRequest()?(a=this.oAuthLoginData(),d.login(a.email,a.tmpKey).then(function(){delete b[e.api.oauth.cookieNS],f.resolve()},f.reject)):f.reject("oauth.params_missing"),f.promise},isOAuthEmailMissingRequest:function(){var b=a.search();return b&&b["errors[email][]"]&&b["errors[email][]"].indexOf("api.missing_attribute")>=0&&b.provider},providerConfig:function(a){return e.api.oauth[a]}}}]),angular.module("squareteam.app").controller("OAuthLoginCtrl",["$scope","$state","ApiOAuth",function(a,b,c){a.authenticating=!1,a.error="",c.isOAuthLoginRequest()?(a.authenticating=!0,a.login=c.oAuthLoginData().email,c.login().then(function(){b.go("app.home")},function(b){a.authenticating=!1,a.error="auth.bad_login"===b||"auth.bad_password"===b?"public.oauth.login.authenticating_error":"api.serverBusy"})):b.go("public.login")}]),angular.module("squareteam.app").controller("OAuthEmailConfirmCtrl",["$scope","$state","$location","ApiOAuth","stUtils",function(a,b,c,d,e){if(d.isOAuthEmailMissingRequest()){var f=d.providerConfig(c.search().provider),g=f.endpoint;a.confirm=function(){g?e.redirect([g,"?email=",a.user.email].join("")):a.error="public.oauth.email.wrong_provider"}}else b.go("public.login")}]),angular.module("squareteam.app").service("stPolicies",function(){return{REGEXP:{password:new RegExp(/(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}/)},isPasswordValid:function(a){return!!a&&null!==a.match(this.REGEXP.password)}}});