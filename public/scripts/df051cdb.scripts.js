"use strict";angular.module("squareteam.ressources",["ngCookies","ngResource"]),angular.module("squareteam.api",["pascalprecht.translate"]),angular.module("squareteam.app",["squareteam.api","squareteam.ressources","ngSanitize","ui.router","pascalprecht.translate"]),angular.module("squareteam.app").value("lodash",window._);var version="0.2.1";angular.module("squareteam.app").value("VERSION",version),angular.module("squareteam.api").config(["$httpProvider",function(a){a.interceptors.push("ApiHttpInterceptors")}]),angular.module("squareteam.app").config(["$stateProvider","$urlRouterProvider","$translateProvider",function(a,b,c){c.useStaticFilesLoader({prefix:"i18n/",suffix:".json"}),c.preferredLanguage("en");var d={checkAuthenticated:function(a,b,c){var d=b.defer();return a.isAuthenticated()?d.resolve():a.restore().then(function(){a.isAuthenticated()?d.resolve():(c.info("redirect to login"),d.reject({redirectToState:"login"}))}.bind(this)),d.promise}};d.checkAuthenticated.$inject=["CurrentSession","$q","$log"],a.state("login",{url:"/login",controller:"LoginCtrl",templateUrl:"views/login.html"}).state("register",{url:"/register",templateUrl:"views/register.html"}),a.state("app",{"abstract":!0,resolve:{authenticated:d.checkAuthenticated},templateUrl:"views/app/layout.html"}).state("app.organization",{"abstract":!0,template:"<ui-view></ui-view>"}).state("app.organization.create",{url:"/organization/create",templateUrl:"views/register_organization.html"}).state("app.home",{url:"/home",templateUrl:"views/home.html",controller:"HomeCtrl"}).state("app.account",{url:"/account",templateUrl:"views/app/account.html"}).state("app.knowledge",{url:"/knowledge",templateUrl:"views/app/knowledge/index.html"}).state("app.knowledge.create",{url:"/knowledge/add"}).state("app.knowledge.edit",{url:"/knowledge/edit/:item_id"}).state("app.knowledge.by_project",{url:"/knowledge/filter/project/:project_id"}).state("app.knowledge.by_mission",{url:"/knowledge/filter/mission/:mission_id"}).state("app.knowledge.by_tags",{url:"/knowledge/filter/tags/:tags"}).state("app.projects",{url:"/projects",templateUrl:"views/app/projects/index.html"}).state("app.projects.create",{url:"/projects/add"}).state("app.projects.edit",{url:"/projects/edit/:project_id"}).state("app.missions",{url:"/projects/:project_id/missions"}).state("app.my_missions",{url:"/missions/mine"}).state("app.missions.add",{url:"/add"}).state("app.missions.view",{url:"/:mission_id"}).state("app.missions.edit",{url:"/:mission_id/edit"}).state("app.tasks",{url:"/missions/:mission_id/tasks",templateUrl:"views/app/missions/index.html"}).state("app.tasks.add",{url:"/add"}).state("app.tasks.view",{url:"/:task_id"}).state("app.tasks.edit",{url:"/:task_id/edit"}),b.otherwise("/home")}]),angular.module("squareteam.app").factory("appConfig",function(){var a={host:"http://alpha.squareteam.io",path:"/api/",storageNS:"st.session"};return a.url=a.host+a.path,a.oauth={cookieNS:"st.oauth"},a.oauth.github={loginUrl:a.url+"auth/github"},{api:a}}),angular.module("squareteam.ressources").factory("UserRessource",["$resource","$http",function(a,b){var c;return c=a("apis://users/:id",{},{update:{method:"PUT"}}),c.create=function(a){return b.post("api://user",a)},c.organizations=a("apis://users/:userId/organizations",{}),c}]),angular.module("squareteam.app").service("CurrentSession",["$rootScope","$http","$q","appConfig","ApiAuth","ApiCrypto","ApiErrors","ApiSessionStorageCookies",function(a,b,c,d,e,f,g,h){this.$$user=null,this.$$auth=new e,this.$$organizations=[],this.isAuthenticated=function(){return this.$$auth&&this.$$auth.$isValid()&&!!this.$$user},this.getOrganizations=function(){return this.$$organizations},this.getAuth=function(){return this.$$auth},this.getUser=function(){return this.$$user},this.unregister=function(){this.$$auth=new e,this.$$user=null,a.$broadcast("user:disconnected")},this.register=function(e){var h=this,i=c.defer();return b({method:"GET",url:d.api.url+"user/me",headers:angular.extend({"X-Requested-With":"XMLHttpRequest"},f.generateHeaders(e,d.api.url+"user/me","GET",{}))}).then(function(b){h.$$auth=e,h.$$user=b.data,a.$broadcast("user:connected"),i.resolve(b.data)},function(a){i.reject(a.error instanceof g.Http?"api.not_available":"auth.invalid")}),i.promise},this.save=function(){var a=c.defer();return this.isAuthenticated()?h.store(this.getAuth())?a.resolve():a.reject("session.storage.unable_to_store"):a.reject("session.invalid"),a.promise},this.restore=function(){var a=c.defer(),b=h.retrieve();return b?this.register(b).then(function(){a.resolve()},function(b){h.destroy(),a.resolve(b)}):a.resolve("session.storage.no_session"),a.promise}}]),angular.module("squareteam.api").factory("ApiHttpInterceptors",["$q","$injector","ApiErrors","appConfig",function(a,b,c,d){function e(a){a.error=angular.isDefined(a.data)&&angular.isDefined(a.data.errors)&&a.data.errors.length?new c.Api(a.data.errors):new c.Http(a.status,a.data)}var f=/^apis?:\/\//,g=/^apis:\/\//,h=new RegExp("^"+d.api.url);return{request:function(a){var c=b.get("ApiCrypto"),e=g.test(a.url);return f.test(a.url)&&(a.url=a.url.replace(f,d.api.url),e&&(a=c.transformRequest(a)),a.data&&(a.headers["Content-Type"]="application/x-www-form-urlencoded",a.data=$.param(a.data))),a},response:function(b){return h.test(b.config.url)?!b.data.errors&&b.status<=201?(b.data=b.data.data,b):(e(b),a.reject(b)):b},responseError:function(b){return e(b),a.reject(b)}}}]),angular.module("squareteam.api").service("ApiCrypto",["$injector","appConfig",function(a,b){this.generateToken=function(a,b,c,d){var e=CryptoJS.PBKDF2(b,c,{keySize:8,iterations:1e3,hasher:CryptoJS.algo.SHA256}),f=CryptoJS.algo.HMAC.create(CryptoJS.algo.SHA256,d.concat(e));return f.update(a),f.finalize()},this.generateHeaders=function(a,c,d,e){var f,g,h,i=[];return h=c.replace(b.api.host,""),"/"!==h[0]&&(h="/"+h),e&&angular.isObject(e)&&angular.forEach(Object.keys(e).sort(),function(a){i.push(encodeURIComponent(a).replace("%20","+")+"="+encodeURIComponent(e[a]).replace("%20","+"))}),f={"St-Identifier":a.identifier,"St-Timestamp":Math.round(Date.now()/1e3)},g=CryptoJS.algo.HMAC.create(CryptoJS.algo.SHA256,a.token),g.update(d+":"),g.update(h+":"),g.update(f["St-Timestamp"]+":"),g.update(i.join("&")),f["St-Hash"]=g.finalize().toString(),f["X-Requested-With"]="XMLHttpRequest",f},this.transformRequest=function(b){var c=a.get("CurrentSession"),d=c.getAuth();if(!c.isAuthenticated())throw new Error("Cannot load "+b.url+" without being authenticated !");return angular.extend(b.headers,this.generateHeaders(d,b.url,b.method,b.data)),b}}]),angular.module("squareteam.api").service("ApiSessionStorageCookies",["$cookies","ApiAuth","appConfig",function(a,b,c){this.store=function(b){return b.$isValid()?void(a[c.api.storageNS]=[b.identifier,b.token.toString()].join(":")):!1},this.retrieve=function(){if(this.empty())return!1;var d=a[c.api.storageNS].split(":");return 2===d.length?new b(d[0],CryptoJS.enc.Hex.parse(d[1])):!1},this.destroy=function(){delete a[c.api.storageNS]},this.empty=function(){return angular.isUndefined(a[c.api.storageNS])}}]),angular.module("squareteam.api").factory("ApiAuth",function(){return function(a,b){this.token=b,this.identifier=a,this.$isValid=function(){return!!(this.token&&this.token.words&&this.token.sigBytes&&this.identifier)}}}),angular.module("squareteam.api").service("ApiSession",["$rootScope","$http","$q","appConfig","CurrentSession","ApiSessionStorageCookies","ApiAuth","ApiCrypto","ApiErrors",function(a,b,c,d,e,f,g,h,i){this.login=function(a,d){function f(){b.put("api://login",{identifier:a}).then(function(b){b&&b.data&&b.data.salt1&&b.data.salt1.length>0&&b.data.salt2&&b.data.salt2.length>0?(k.identifier=a,k.token=h.generateToken(a,d,CryptoJS.enc.Hex.parse(b.data.salt1),CryptoJS.enc.Hex.parse(b.data.salt2)),e.register(k).then(function(){e.save(),j.resolve()},function(a){j.reject("auth.invalid"===a?"auth.bad_password":"api.not_available")})):j.reject("api.response_malformed")},function(a){j.reject(a.error instanceof i.Http?"api.not_available":"auth.bad_login")})}var j=c.defer(),k=new g;return e.isAuthenticated()?this.logout().then(f,j.reject):f(),j.promise},this.logout=function(a){var d=c.defer();return a=angular.isDefined(a)?a:!0,e.isAuthenticated()?b.get("apis://logout").then(function(){a&&f.destroy(),e.unregister(),d.resolve()},function(){d.reject("api.not_available")}):d.reject("session.invalid"),d.promise}}]),angular.module("squareteam.app").controller("HomeCtrl",function(){}),angular.module("squareteam.app").directive("match",function(){return{require:"ngModel",restrict:"A",scope:{match:"="},link:function(a,b,c,d){a.$watch(function(){return d.$pristine&&angular.isUndefined(d.$modelValue)||a.match===d.$modelValue},function(a){d.$setValidity("match",a)})}}}),angular.module("squareteam.app").directive("stLoginForm",function(){return{templateUrl:"scripts/directives/templates/stloginform.html",restrict:"E",scope:{redirectPath:"@",githubLogin:"@"},replace:!0,controller:["$scope","$element","$attrs","$state","ApiSession","appConfig",function(a,b,c,d,e,f){a.githubLoginUrl=f.api.oauth.github.loginUrl,a.login=function(){a.loginForm.email.$setValidity("valid",!0),a.loginForm.password.$setValidity("valid",!0),a.serverBusy=!1,e.login(a.user.email,a.user.password).then(function(){d.go(a.redirectPath||"app.home")},function(b){"auth.bad_login"===b?a.loginForm.email.$setValidity("valid",!1):"auth.bad_password"===b?a.loginForm.password.$setValidity("valid",!1):a.serverBusy=!0})}}]}}),angular.module("squareteam.app").factory("ApiErrors",function(){function a(a){this.errors=a}function b(a,b){this.status=a,this.message=b}return angular.extend(a.prototype,{toString:function(){return"ApiError : "+this.errors.join(", ")},getErrors:function(){return this.errors}}),angular.extend(b.prototype,{toString:function(){return"HttpError("+this.status+"): "+this.message}}),{Api:a,Http:b}}),angular.module("squareteam.app").run(["$rootScope","$state",function(a,b){a.$on("$stateChangeError",function(a,c,d,e,f,g){angular.isObject(g)&&g.redirectToState&&g.redirectToState!==c.name&&b.go(g.redirectToState)})}]),angular.module("squareteam.app").directive("stUserCreate",function(){return{templateUrl:"scripts/directives/templates/stusercreate.html",restrict:"E",replace:!0,controller:["$scope","$element","$attrs","$location","UserRessource","ApiErrors","CurrentSession","ApiSession","ApiCrypto","ApiAuth",function(a,b,c,d,e,f,g,h,i,j){a.register=function(){a.registerForm.email.$setValidity("unique",!0),a.serverBusy=!1,e.create({name:a.user.login,email:a.user.email,password:a.user.password}).then(function(b){var c=i.generateToken(a.user.email,a.user.password,CryptoJS.enc.Hex.parse(b.data.salt1),CryptoJS.enc.Hex.parse(b.data.salt2));g.register(new j(a.user.email,c)).then(function(){g.save(),d.path("/home")},function(){a.serverBusy=!0})},function(b){b.error instanceof f.Api?angular.forEach(b.error.getErrors(),function(b){"Email has already been taken"===b&&a.registerForm.email.$setValidity("unique",!1)}.bind(this)):a.serverBusy=!0})}}]}}),angular.module("squareteam.ressources").factory("OrganizationRessource",["$resource",function(a){var b;return b=a("apis://organizations/:id",{},{update:{method:"PUT"}}),b.members=a("apis://organizations/:org_id/members/:id",{}),b}]),angular.module("squareteam.app").controller("ApplicationCtrl",["$rootScope","$scope","$state","$translate","ApiSession","CurrentSession","VERSION",function(a,b,c,d,e,f,g){b.session=e,b.currentSession=f,b.version=g,b.$translate=d,b.logout=function(){e.logout().then(function(){c.go("login")}.bind(this),function(){c.go("app.home")}.bind(this))}}]),angular.module("squareteam.app").directive("stOrganizationCreate",function(){return{scope:{forUsers:"=",redirectPath:"@"},templateUrl:"scripts/directives/templates/storganizationcreate.html",restrict:"E",replace:!0,controller:["$scope","$element","$attrs","$location","$http","OrganizationRessource","ApiErrors",function(a,b,c,d,e,f,g){function h(b){b.error instanceof g.Api?angular.forEach(b.error.getErrors(),function(b){"Name has already been taken"===b&&a.createOrganizationForm.name.$setValidity("unique",!1)}):a.serverBusy=!0}a.create=function(){a.serverBusy=!1,a.createOrganizationForm.name.$setValidity("unique",!0);var b=f.save({},a.organization,function(){function c(){d.path(a.redirectPath||"/home")}if(a.forUsers&&a.forUsers.length){var f={organization_id:b.id,user_id:a.forUsers[0],admin:1};e.post("apis://members",f).then(function(){c()},h)}else c()},h)}}]}}),angular.module("squareteam.app").controller("LoginCtrl",["$scope","$cookies","$location","$state","ApiSession","appConfig",function(a,b,c,d,e,f){var g=c.search()&&c.search().email;a.login=g||"",a.oauthAuthenticating=!1,b[f.api.oauth.cookieNS]&&(a.oauthAuthenticating=!0,e.login(g,b[f.api.oauth.cookieNS]).then(function(){delete b[f.api.oauth.cookieNS],d.go("app.home")}))}]),angular.module("squareteam.app").directive("stUserProfile",function(){return{templateUrl:"scripts/directives/templates/stuserprofile.html",restrict:"E",scope:{userId:"=",editable:"@"},replace:!0,compile:function(a,b){"undefined"==typeof b.editable&&a.find("input").each(function(a,b){var c=$(b),d=c.attr("ng-model");c.replaceWith("<span>{{ "+d+" }}</span>")})},controller:["$scope","$element","$attrs","$location","UserRessource","lodash",function(a,b,c,d,e,f){var g,h;h=f.throttle(function(a){a&&e.update({id:a.id},{email:a.email,name:a.name})},1e3,{leading:!1}),g=e.get({id:a.userId},function(){a.user=g,a.$watchCollection("user",h)}.bind(this),function(){console.error("Failed to load user#"+a.userId)}),e.organizations.query({userId:a.userId},function(b){a.organizations=b}.bind(this),function(){console.error("Failed to load organizations for user#"+a.userId)})}]}});